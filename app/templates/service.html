{% extends "base.html" %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3>Servicio al Cliente IA</h3>
    </div>
    <div class="filters">
        <input type="text" id="table-search" class="search-input" placeholder="Buscar por teléfono o nombre..."
            onkeyup="filterTable('service-table', this.value)">
    </div>

    <div class="table-responsive">
        <table class="table sortable" id="service-table">
            <thead>
                <tr>
                    <th onclick="sortTable(0, 'service-table')">ID (Teléfono) <i class="fa-solid fa-sort"></i></th>
                    <th onclick="sortTable(1, 'service-table')">Nombre <i class="fa-solid fa-sort"></i></th>
                    <th onclick="sortTable(2, 'service-table')">Correo <i class="fa-solid fa-sort"></i></th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <!-- Populated by JS -->
            </tbody>
        </table>
    </div>

    <!-- Chat History Modal -->
    <div id="chat-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px; height: 80vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h3>Chat con <span id="chat-modal-phone"></span></h3>
                <button onclick="closeChatModal()" class="modal-close">&times;</button>
            </div>

            <div
                style="padding: 10px; border-bottom: 1px solid var(--color-border); display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <input type="text" id="chat-text-search" placeholder="Buscar texto..."
                    style="padding: 5px; border: 1px solid #ccc; border-radius: 4px; flex: 1;">
                <input type="date" id="chat-date-filter"
                    style="padding: 5px; border: 1px solid #ccc; border-radius: 4px;">
                <button class="btn btn-sm btn-primary" onclick="loadChatHistory()"><i class="fa-solid fa-filter"></i>
                    Filtrar</button>
                <button class="btn btn-sm" onclick="clearChatFilter()"><i class="fa-solid fa-times"></i></button>
            </div>

            <div id="chat-container" style="flex: 1; overflow-y: auto; padding: 15px; background: #f9f9f9;">
                <!-- Messages populated here -->
            </div>
        </div>
    </div>
</div>

<script>
    let currentChatPhone = null;

    document.addEventListener('DOMContentLoaded', async () => {
        await checkAuth();
        loadServiceCustomers();
    });

    async function loadServiceCustomers() {
        const api = new ApiClient();
        const tbody = document.querySelector('#service-table tbody');
        tbody.innerHTML = '<tr><td colspan="4">Cargando...</td></tr>';

        try {
            // Fetch customers (which acts as our user list for now)
            const customers = await api.get('/chat/customers');

            if (customers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">No hay usuarios registrados.</td></tr>';
                return;
            }

            tbody.innerHTML = customers.map(c => `
                <tr>
                    <td>${c.phone}</td>
                    <td>${c.name || 'N/A'}</td>
                    <td>${c.email || 'N/A'}</td>
                    <td>
                        <button class="btn btn-sm btn-table-action" onclick="openChatModal('${c.phone}')">
                            <i class="fa-solid fa-comments"></i> Ver Chat
                        </button>
                    </td>
                </tr>
            `).join('');
        } catch (e) {
            console.error(e);
            tbody.innerHTML = '<tr><td colspan="4">Error al cargar usuarios.</td></tr>';
        }
    }

    async function openChatModal(phone) {
        currentChatPhone = phone;
        document.getElementById('chat-modal-phone').innerText = phone;
        document.getElementById('chat-date-filter').value = '';
        document.getElementById('chat-modal').style.display = 'flex';
        await loadChatHistory();
    }

    function closeChatModal() {
        document.getElementById('chat-modal').style.display = 'none';
        currentChatPhone = null;
    }

    function clearChatFilter() {
        document.getElementById('chat-date-filter').value = '';
        document.getElementById('chat-text-search').value = '';
        loadChatHistory();
    }

    async function loadChatHistory() {
        if (!currentChatPhone) return;

        const container = document.getElementById('chat-container');
        container.innerHTML = '<div style="text-align:center;">Cargando chat...</div>';

        const dateFilter = document.getElementById('chat-date-filter').value;
        const textSearch = document.getElementById('chat-text-search').value.trim();
        const api = new ApiClient();

        try {
            let url = `/chat/${currentChatPhone}/history?`;
            if (dateFilter) url += `date_filter=${dateFilter}&`;
            if (textSearch) url += `text_search=${textSearch}&`;

            // Remove trailing '&' if any
            if (url.endsWith('?')) {
                url = url.slice(0, -1); // Remove '?' if no parameters were added
            } else if (url.endsWith('&')) {
                url = url.slice(0, -1); // Remove trailing '&'
            }

            const messages = await api.get(url);

            if (messages.length === 0) {
                container.innerHTML = '<div style="text-align:center; color: #888;">No hay mensajes registrados.</div>';
                return;
            }

            // Messages are already sorted Newest to Oldest from backend
            // We'll render them.
            container.innerHTML = messages.map(msg => {
                const isAI = msg.sender === 'ai';
                const align = isAI ? 'left' : 'right';
                const bg = isAI ? '#e9ecef' : '#007bff';
                const color = isAI ? 'black' : 'white';
                // Format date as DD/MM/YYYY HH:mm in Costa Rica Timezone
                const time = new Date(msg.created_at).toLocaleString("es-CR", {
                    timeZone: "America/Costa_Rica",
                    day: "2-digit",
                    month: "2-digit",
                    year: "numeric",
                    hour: "2-digit",
                    minute: "2-digit",
                    hour12: true
                });

                let content = msg.content;
                if (msg.message_type === 'image') {
                    content = `<a href="${msg.content}" target="_blank" style="color: ${isAI ? 'blue' : 'gold'}; text-decoration: underline; font-weight: bold;">
                                <i class="fa-solid fa-image"></i> IMAGEN
                               </a>`;
                }

                return `
                    <div style="display: flex; flex-direction: column; align-items: ${isAI ? 'flex-start' : 'flex-end'}; margin-bottom: 10px;">
                        <div style="background: ${bg}; color: ${color}; padding: 8px 12px; border-radius: 12px; max-width: 70%; word-wrap: break-word;">
                            ${content}
                        </div>
                        <small style="color: #999; font-size: 0.75em; margin-top: 2px;">${time} - ${isAI ? 'IA' : 'Usuario'}</small>
                    </div>
                `;
            }).join('');

        } catch (e) {
            console.error(e);
            container.innerHTML = '<div style="text-align:center; color: red;">Error al cargar historial.</div>';
        }
    }
</script>
{% endblock %}