{% extends "base.html" %}

{% block content %}
<div class="card">
    <div
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 10px;">
        <h3>Usuarios</h3>
        <button class="btn btn-primary" onclick="openCreateUserModal()"><i class="fa-solid fa-plus"></i> Nuevo
            Usuario</button>
    </div>

    <div class="filters">
        <input type="text" id="table-search" class="search-input" placeholder="Buscar usuarios..."
            onkeyup="filterTable('users-table', this.value)">
    </div>

    <div class="table-responsive">
        <table class="table sortable" id="users-table">
            <thead>
                <tr>
                    <th onclick="sortTable(0, 'users-table')">Nombre <i class="fa-solid fa-sort"></i></th>
                    <th onclick="sortTable(1, 'users-table')">Email <i class="fa-solid fa-sort"></i></th>
                    <th onclick="sortTable(2, 'users-table')">Rol <i class="fa-solid fa-sort"></i></th>
                    <th onclick="sortTable(3, 'users-table')">Estado <i class="fa-solid fa-sort"></i></th>
                </tr>
            </thead>
            <tbody>
                <!-- Populated by JS -->
            </tbody>
        </table>
    </div>
</div>

<!-- Create User Modal (Simple overlay for MVP) -->
<!-- Create User Modal -->
<div id="create-user-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Crear Usuario</h3>
            <button onclick="closeCreateUserModal()" class="modal-close">&times;</button>
        </div>
        <form id="create-user-form">
            <div class="form-group">
                <label>Nombre</label>
                <input type="text" name="name" required placeholder="Nombre completo">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" name="email" required placeholder="usuario@lavete.com">
            </div>
            <div class="form-group">
                <label>Rol</label>
                <select name="role"
                    style="width: 100%; padding: 0.75rem; border: 1px solid var(--color-border); border-radius: var(--radius-sm); background: white;">
                    <option value="seller">Vendedor</option>
                    <option value="admin">Administrador</option>
                </select>
            </div>
            <div class="form-group">
                <label>Contraseña</label>
                <input type="password" name="password" required placeholder="••••••••">
            </div>
            <div style="margin-top: 20px;">
                <button type="submit" class="btn btn-primary btn-block">Crear Usuario</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        await checkAuth();
        loadUsers();
    });

    async function loadUsers() {
        const api = new ApiClient();
        try {
            const users = await api.get('/users/');
            const tbody = document.querySelector('#users-table tbody');
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td>${u.name}</td>
                    <td>${u.email}</td>
                    <td>${u.role}</td>
                    <td><span class="badge ${u.is_active ? 'active' : 'danger'}">${u.is_active ? 'Activo' : 'Inactivo'}</span></td>
                </tr>
            `).join('');
        } catch (e) {
            console.error(e);
            // Likely 403 if not admin, should handle gracefully
            if (e.message.includes('403') || e.message.includes('Unauthorized')) {
                document.querySelector('.card').innerHTML = '<h3>Acceso Denegado</h3><p>Solo administradores pueden ver esta sección.</p>';
            }
        }
    }

    function openCreateUserModal() {
        document.getElementById('create-user-modal').style.display = 'flex';
    }

    function closeCreateUserModal() {
        document.getElementById('create-user-modal').style.display = 'none';
        document.getElementById('create-user-form').reset();
    }

    document.getElementById('create-user-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());

        try {
            const api = new ApiClient();
            await api.post('/users/', data);
            closeCreateUserModal();
            loadUsers();
        } catch (err) {
            alert('Error al crear usuario: ' + err.message);
        }
    });
</script>
{% endblock %}